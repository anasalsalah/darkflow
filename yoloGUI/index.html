<!DOCTYPE html>
<script src="resources/Shape.js"></script>
<script src="resources/CanvasState.js"></script>
<script src="resources/jsonFunctions.js"></script>
<script>

var myCanvState;
var selectedThumbImg;
var imagesArrayLength;

function init() {

  myCanvState = new CanvasState(document.getElementById('theCanvas'), document.getElementById('imageContents'));
  myCanvState.canvas.addEventListener('updateSelectedBox', updatedSelectedBoxLabelInput, true);
  myCanvState.canvas.addEventListener('updateCanvas', updateJsonFromCanvas, true);

  selectThumbnailImage(0, '{{ images_array.0.work_image }}','{{ images_array.0.json_file }}')

  imagesArrayLength = {{ images_array|length }}
}


function selectThumbnailImage(thumbIndex, imageFile, jsonFile) {

  //save the contents of the json file to the server
  imageContents = document.getElementById('imageContents');
  imageContents.onload = loadJsonFile(jsonFile);
  imageContents.src = imageFile;

  //change class of previously selected thumb to "Done"
  setSelectedImageDone();

  //change class of currently selected thumb to "Selected"
  selectedThumbImg = document.getElementById("thumbImg" + thumbIndex);
  selectedThumbImg.classList.remove("thumb-done");
  selectedThumbImg.classList.add("thumb-selected");
}


function setSelectedImageDone() {

  if (selectedThumbImg != null) {
    selectedThumbImg.classList.remove("thumb-selected");
    selectedThumbImg.classList.add("thumb-done");

    //save the json data for the current image
    var jsonContents = document.getElementById('jsonContents');
    if(jsonContents != null && jsonContents.name != "")
      saveJsonFile(jsonContents.name, jsonContents.textContent);
  }
}

function selectPreviousImage() {

  var currentId = selectedThumbImg.id;
  var currentIndex = currentId.split("thumbImg")[1];
  var prevIndex = parseInt(currentIndex) - 1;
  var prevThumbImg = document.getElementById("thumbImg" + prevIndex);

  setSelectedImageDone();

  if (prevThumbImg!=null)
    prevThumbImg.click();


}

function selectNextImage() {

  var currentId = selectedThumbImg.id;
  var currentIndex = currentId.split("thumbImg")[1];
  var nextIndex = parseInt(currentIndex) + 1;
  var nextThumbImg = document.getElementById("thumbImg" + nextIndex);

  setSelectedImageDone();

  if (nextThumbImg!=null)
    nextThumbImg.click();
}


function updatedSelectedBoxLabelInput() {
  if(myCanvState.selection)
    document.getElementById("selectedBoxLabel").value = myCanvState.selection.label;
  else
    document.getElementById("selectedBoxLabel").value = "";
}


function buttonUpdateSelectedBoxLabel() {

  myCanvState.updateSelectedBoxLabel(document.getElementById("selectedBoxLabel").value);
}


function keyboardUpdateSelectedBoxLabel(e) {

  if (event.keyCode === 13)
    myCanvState.updateSelectedBoxLabel(document.getElementById("selectedBoxLabel").value);
}


function buttonDeleteSelectedBox() {

  myCanvState.deleteSelectedBox();
}


function keyboardDeleteSelectedBox() {

  if (event.keyCode === 46)
    myCanvState.deleteSelectedBox();
}


function buttonNewBox() {
  myCanvState.addShape(new Shape(50, 50, 50, 50, 'rgba(127, 127, 212, .5)', 'New'));
}


function displayInfoPopup() {
  var popup = document.getElementById("infoPopup");
  popup.classList.toggle("show");
}
</script>

<html>
<head>
  <link rel="stylesheet" href="resources/styles.css">
</head>
<body onLoad='init()'>
  <img id="imageContents" src="" style="display:none">
  <textarea id="jsonContents" readonly rows="5" cols="75"></textarea><!-- style="display:none" -->
  <h1 style="color:green">Welcome to the Yoloapp!</h1>
  <h3>You are now working on gTrack issue #<a target="_blank" href="https://redmine.globalme.net/issues/{{ issue_id }}">{{ issue_id }}</a></h3>
  <table>
  <tr>
    <td valign="top">
      <!-- TODO: set class of image based on its status -->
      <div class="imageScroller">
        {% for image in images_array %}
            <img src="{{ image.thumb_image }}" class="thumb" id="thumbImg{{ forloop.counter0 }}" onclick="selectThumbnailImage({{ forloop.counter0 }},'{{ image.work_image }}','{{ image.json_file }}')">
        {% endfor %}
      </div>
    </td>
    <td valign="top" style="border: 1px solid #ddd;">
      <input type="button" style="width:117px" id="newBoxButton" name="newBoxButton" value="New Box" onclick="buttonNewBox()"/>
      <input type="button" style="width:117px" id="deleteBoxButton" name="deleteBoxButton" value="Delete Box" onclick="buttonDeleteSelectedBox()"/>
      Total Boxes: <span id="numOfBoxes"></span>
      <div class="popup" onclick="displayInfoPopup()">
        <img src="resources/info_icon.png" width="20" height="20"/>
        <span class="popuptext" id="infoPopup">
          Shortcuts:<br/>
          Double-click in image to create new box.<br/>
          Delete key: deletes a selected box.<br/>
          Enter key: saves a modified label.
        </span>
      </div>
      <br/>Selected Box:
      <input type="text" style="width:140px;margin-bottom:5px;margin-top:5px;" id="selectedBoxLabel" name="selectedBoxLabel" label="Box Label" onkeyup="keyboardUpdateSelectedBoxLabel(this)" placeholder="Press Enter to Save"/>
      <input type="button" style="width:117px" id="updateBoxButton" name="updateBoxButton" value="Save Label" onclick="buttonUpdateSelectedBoxLabel()"/>
      <br/>
      <br/>
      <input type="button" style="width:117px" id="PrevImageButton" name="PrevImageButton" value="Prev Image" onclick="selectPreviousImage()"/>
      <input type="button" style="width:117px" id="NextImageButton" name="NextImageButton" value="Next Image" onclick="selectNextImage()"/>
      <br/>
      <br/>
      <canvas id="theCanvas" style="border:3px solid #000000;" tabindex='1' onkeyup="keyboardDeleteSelectedBox()"></canvas>
      <br/>
    </td>
  </tr>
  </table>
</body>
</html>
