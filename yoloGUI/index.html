<!DOCTYPE html>
<script src="resources/Shape.js"></script>
<script src="resources/BBox.js"></script>
<script src="resources/Path.js"></script>
<script src="resources/CanvasState.js"></script>
<script src="resources/jsonFunctions.js"></script>
<script>

let myCanvState;
let selectedThumbImg;
let labelData;

let imagesArrayLength = {{ images_array|length }};
let issueId = {{ issue_id }};
let folderId = {{ folder_id }};

function init() {

  loadLabelLists();

  myCanvState = new CanvasState(document.getElementById('theCanvas'), document.getElementById('imageContents'));
  myCanvState.canvas.addEventListener('updateSelectedBox', updatedSelectedBoxLabelFromCanvas, true);
  myCanvState.canvas.addEventListener('updateCanvas', updateJsonFromCanvas, true);
  myCanvState.canvas.addEventListener('drawingChildFinished', resetSelectPartType, true);
  selectThumbnailImage(0, '{{ images_array.0.work_image }}','{{ images_array.0.json_file }}');
}


function selectThumbnailImage(thumbIndex, imageFile, jsonFile) {

  //get the contents of the json file for the selected image from the server
  imageContents = document.getElementById('imageContents');
  imageContents.onload = loadJsonFile(jsonFile);
  imageContents.src = imageFile;

  //change class of previously selected thumb to "Done"
  setSelectedImageDone();

  //change class of currently selected thumb to "Selected"
  selectedThumbImg = document.getElementById("thumbImg" + thumbIndex);
  selectedThumbImg.classList.remove("thumb-unselected");
  selectedThumbImg.classList.remove("thumb-done");
  selectedThumbImg.classList.add("thumb-selected");

  myCanvState.deselectShape();
  checkShowDoneButton();
}

function checkShowDoneButton() {

  let thumbImg;
  for (let i=0; i<imagesArrayLength; i++) {
    if(document.getElementById("thumbImg" + i).classList.contains("thumb-unselected"))
      return; // exit if at least one image is still not done yet
  }

  //for loop did not detect any not-done images
  document.getElementById("doneButton").style = "";
}


function setSelectedImageDone() {

  if (selectedThumbImg != null) {
    //save the json data for the current image
    let jsonContents = document.getElementById('jsonContents');
    saveJsonFile(jsonContents.name, jsonContents.textContent);

    selectedThumbImg.classList.remove("thumb-selected");
    selectedThumbImg.classList.add("thumb-done");
  }
}

function selectPreviousImage() {

  let currentId = selectedThumbImg.id;
  let currentIndex = currentId.split("thumbImg")[1];
  let prevIndex = parseInt(currentIndex) - 1;
  let prevThumbImg = document.getElementById("thumbImg" + prevIndex);

  setSelectedImageDone();

  if (prevThumbImg!=null) {
    prevThumbImg.click();
    myCanvState.deselectShape();
  }
}


function selectNextImage() {

  let currentId = selectedThumbImg.id;
  let currentIndex = currentId.split("thumbImg")[1];
  let nextIndex = parseInt(currentIndex) + 1;
  let nextThumbImg = document.getElementById("thumbImg" + nextIndex);

  setSelectedImageDone();

  if (nextThumbImg!=null) {
    nextThumbImg.click();
    myCanvState.deselectShape();
  }
}


function updatedSelectedBoxLabelFromCanvas() {

  let selectLabel = document.getElementById("selectBoxLabel");

  if(myCanvState.selectedShape && myCanvState.selectedShape.label == selectLabel.value)
    return; //no need to do anything since canvas box label matches dropdown value

  if(myCanvState.selectedShape)
    selectLabel.value = myCanvState.selectedShape.label;
  else
    selectLabel.value = "";

  displayAddPartFields(selectLabel.value);
}


function updateSelectedBoxLabel(selectLabel) {

  myCanvState.updateSelectedBoxLabel(selectLabel.value);
  displayAddPartFields(selectLabel.value);
}

function resetSelectPartType() {
    document.getElementById("selectPartType").value = DRAWING_NONE;
    document.getElementById("partInstructions").textContent = "";
}

function updateSelectedPartType(selectPart) {

  myCanvState.setDrawing(selectPart.value);
  let instructions = document.getElementById("partInstructions");

  switch (selectPart.value) {

    case DRAWING_NONE:
      instructions.textContent = "";
      break;
    case DRAWING_HEAD:
      instructions.textContent = "Click and drag to draw a box for the head.";
      break;
    case DRAWING_TORSO:
      instructions.textContent = "Click 4 times on the image in this order: left shoulder, right shoulder, right hip, left hip."
      break;
    case DRAWING_CARWHEELS:
      instructions.textContent = "Click 5 times on the image in this order: front-left wheel, front-right, back-right, back-left, and finally the front license plate."
      break;
  }


}


function displayAddPartFields(label) {

  selectPart = document.getElementById("selectPartType");

  // remove any existing options
  for(let k=selectPart.options.length-1; k >= 0; k--) {
    selectPart.options.remove(k);
  }
  // add default option and select it
  let option = document.createElement("option");
  option.text = "Add Part";
  option.value = DRAWING_NONE;
  selectPart.add(option);
  selectPart.value = DRAWING_NONE;

  //check if current label has parts and populate dropdown accordingly
  if (labelData && labelData.labels) {
      for (let i=0; i < labelData.labels.length; i++) {
        if (labelData.labels[i].name == label && labelData.labels[i].parts) {
            //display the Add Part dropdown
            selectPart.style.display = "";
            let labelParts = labelData.labels[i].parts
            //add the parts to the dropdown
            for(let j=0; j < labelParts.length; j++) {
                option = document.createElement("option");
                option.text = labelParts[j].name;
                option.value = labelParts[j].name;
                selectPart.add(option);
            }
            return;
        }
      }
  }
  // could not find parts for selected label. hide the parts dropdown.
  selectPart.style.display = "none";
  updateSelectedPartType(selectPart);
}


function buttonDeleteSelectedBox() {

  myCanvState.deleteSelectedShape();
}


function keyboardShortcut() {

  switch (event.keyCode) {

    case 27: // Escape key
      myCanvState.deselectShape();
      break;
    case 46: // Delete key
      myCanvState.deleteSelectedShape();
      break;
    case 67: // 'c' for car
      selectBoxLabel.value = 'car';
      updateSelectedBoxLabel(selectBoxLabel);
      break;
    case 80: // 'p' for person
      selectBoxLabel.value = 'person';
      updateSelectedBoxLabel(selectBoxLabel);
      break;
    case 66: // 'b' for bicycle
      selectBoxLabel.value = 'bicycle';
      updateSelectedBoxLabel(selectBoxLabel);
      break;
    case 77: // 'm' for motorcycle
      selectBoxLabel.value = 'motorcycle';
      updateSelectedBoxLabel(selectBoxLabel);
      break;
    case 72: // 'h' for head
      selectPartType.value = DRAWING_HEAD;
      updateSelectedPartType(selectPartType);
      break;
    case 84: // 't' for torso
      selectPartType.value = DRAWING_TORSO;
      updateSelectedPartType(selectPartType);
      break;
    case 87: // 'w' for wheels
      selectPartType.value = DRAWING_CARWHEELS;
      updateSelectedPartType(selectPartType);
      break;
  }
}


function buttonNewBox() {

  myCanvState.addShape(new BBox(50, 50, 50, 50, myCanvState.bboxStyle, 'New'));
}

function displayInfoPopup(popupId) {

  let popup = document.getElementById(popupId);
  popup.classList.toggle("show");
}
</script>

<html>
<head>
  <link rel="stylesheet" href="resources/styles.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body onLoad='init()' style="padding:5px;">
  <!-- two hidden fields for storing currently selected image and its json data -->
  <img id="imageContents" src="" style="display:none">
  <textarea id="jsonContents" readonly rows="5" cols="75" ></textarea> <!-- style="display:none" -->
  <h1 style="color:green">Welcome to the Yoloapp!</h1>
  <h3>You are now working on gTrack issue #<a target="_blank" href="https://redmine.globalme.net/issues/{{ issue_id }}">{{ issue_id }}</a></h3>
  <br/>
  <table style="padding: 5px;">
  <tr>
    <td valign="top" style="padding:5px;">
      <!-- TODO: set class of image based on its status -->
      <div class="imageScroller" style="border: 1px solid grey;">
        {% for image in images_array %}
            <img src="{{ image.thumb_image }}" class="thumb thumb-unselected" id="thumbImg{{ forloop.counter0 }}"
                 onclick="selectThumbnailImage({{ forloop.counter0 }},'{{ image.work_image }}','{{ image.json_file }}')">
        {% endfor %}
      </div>
    </td>
    <td valign="top" style="padding:5px;">
        <div class="panel-group">
            <b>Edit Boxes</b>
            <div id="boxFields" style="border:1px solid grey; padding: 5px; width: 420px;">
              <input type="button" style="width:125px" id="newBoxButton" name="newBoxButton"
                     value="New Box" onclick="buttonNewBox()"/>
              <input type="button" style="width:125px" id="deleteBoxButton" name="deleteBoxButton"
                     value="Delete Box" onclick="buttonDeleteSelectedBox()"/>
              <!--<input type="button" style="width:125px" id="clearImageButton" name="clearImageButton"
                     value="Clear Image" onclick="myCanvState.clearShapes();updateJsonFromCanvas(true);"/>-->
              <div class="popup" onclick="displayInfoPopup('boxInfoPopup')">
                <img src="resources/info_icon.png" width="20" height="20"/>
                <span class="popuptext" id="boxInfoPopup">
                  Shortcuts:<br/>
                  Double-click in image to create new bounding box.<br/>
                  Delete key: deletes selected box.<br/>
                  Escape key: deselects selected box.<br/>
                  <br/>
                  Press 'b' to set the box label to 'bicycle'.<br/>
                  Press 'c' to set the box label to 'car'.<br/>
                  Press 'm' to set the box label to 'motorcycle'.<br/>
                  Press 'p' to set the box label to 'person'.<br/>
                  <br/>
                  Press 'h' to add a 'head' to a 'person'.<br/>
                  Press 't' to add a 'torso' to a 'person'.<br/>
                  Press 'w' to add 'wheels and license' to a 'car'.<br/>

                </span>
              </div>
              <br/><br/>Selected Box:
              <select id="selectBoxLabel" name="selectBoxLabel" style="padding:3px;"
                      label="Box Label" onchange="updateSelectedBoxLabel(this)"></select>
              <select id="selectPartType" name="selectPartType"  style="padding:3px; display:none;"
                      label="Part Type" value="Add Part" onchange="updateSelectedPartType(this)"></select>
              <span id="partInstructions" style="color: green;"></span>
            </div>
        </div>
      <!-- navigation buttons -->
      <input type="button" style="width:125px" id="PrevImageButton" name="PrevImageButton"
             value="Prev Image" onclick="selectPreviousImage()"/>
      <input type="button" style="width:125px" id="NextImageButton" name="NextImageButton"
             value="Next Image" onclick="selectNextImage()"/>
      <input type="button" style="display:none" id="doneButton" name="doneButton"
             value="I'm Done!" onclick="setSelectedImageDone();updateIssue(issueId, folderId)"/>
      <br/>
      <br/>
      <!-- canvas where all the action happens -->
      <canvas id="theCanvas" style="border:3px solid #000000;" tabindex='1' onkeyup="keyboardShortcut()"></canvas>
      <br/>
    </td>
  </tr>
  </table>
</body>
</html>
