<!DOCTYPE html>
<script src="Shape.js"></script>
<script src="CanvasState.js"></script>
<script>

var myCanvState;

function init() {

  myCanvState = new CanvasState(document.getElementById('theCanvas'), document.getElementById('imageContents'));

  myCanvState.canvas.addEventListener('updateSelectedBox', function(e) {
    if(myCanvState.selection)
      document.getElementById("selectedBoxLabel").value = myCanvState.selection.label;
    else
      document.getElementById("selectedBoxLabel").value = "";
  }, true);

  myCanvState.canvas.addEventListener('updateCanvas', updateJsonFromCanvas, true);

  drawBoxesFromJson(document.getElementById('jsonContents').textContent);
}

function selectThumbnailImage(index) {

  var imgThumbId = 'thumbImg' + index
  var imageContents = document.getElementById(imgThumbId);
  var imageFile = imageContents.src;
  document.getElementById('imageContents').src = imageFile;
  myCanvState.refreshCanvas();
}

function handleImageFile() {
 
  var selectedFile = document.getElementById('imageInput').files[0];
  var imageContents = document.getElementById('imageContents');
  var fileType = /.*image/;

  if (selectedFile.type.match(fileType)) {
     var reader = new FileReader();
        reader.onload = function () {
            imageContents.src = reader.result;
	        myCanvState.refreshCanvas();
        }
        reader.readAsDataURL(selectedFile);
  } 
  else {
    alert("File not supported! Your file type is: " + selectedFile.type);
  }
}

function handleJsonFile() {
 
  var selectedFile = document.getElementById('jsonInput').files[0];
  var jsonContents = document.getElementById('jsonContents');
  var fileType = /.*json/;

  if (selectedFile.type.match(fileType)) {
    var reader = new FileReader();
    reader.onload = function(e) {
      jsonContents.textContent = reader.result;
      drawBoxesFromJson(reader.result);
    }
    reader.readAsText(selectedFile);
  } 
  else {
    jsonContents.textContent = "File not supported! Your file type is: " + selectedFile.type;
  }
}

function drawBoxesFromJson(jsonText) {

  myCanvState.clearShapes();
  try {

    var image = JSON.parse(jsonText).image;
    var boxes = image.boxes;

    if(boxes.length > 0) {
      // disable listening to canvas changes while we are using the json content to update the canvas
      myCanvState.canvas.removeEventListener('updateCanvas', updateJsonFromCanvas, true);

      // the resolution of the actual image stored on the server
      var trueW = image.width;
      var trueH = image.height;
      // the resolution of the image displayed in the browser
      var workW = myCanvState.bgImg.width;
      var workH = myCanvState.bgImg.height;
      // the ratio of size between the two images (opposite to updateJsonFromCanvas)
      var wRatio = workW / trueW;
      var hRatio = workH / trueH;

      for (i=0; i<boxes.length; i++) {
        var label = boxes[i].label;
        var x = Math.round(boxes[i].topleft.x * wRatio);
        var y = Math.round(boxes[i].topleft.y * hRatio);
        var w = Math.round(boxes[i].bottomright.x * wRatio - x);
        var h = Math.round(boxes[i].bottomright.y * hRatio - y);

        myCanvState.addShape(new Shape(x, y, w, h, 'rgba(127, 255, 212, .5)', label));
      }
      // re-enable listening to canvas changes
      myCanvState.canvas.addEventListener('updateCanvas', updateJsonFromCanvas, true);
    }
  }
  catch (err){
    alert ("An error occurred while trying to draw boxes based on the json file: " + err.message);
  }
}

function updateJsonFromCanvas() {

  if (myCanvState.shapes && myCanvState.shapes.length > 0) {
    // get the current json data
    var data = JSON.parse(document.getElementById('jsonContents').textContent);
    var image = data.image
    var shapes = myCanvState.shapes;
    image.boxes = [];

    // the resolution of the actual image stored on the server
    var trueW = image.width;
    var trueH = image.height;
    // the resolution of the image displayed in the browser
    var workW = myCanvState.bgImg.width;
    var workH = myCanvState.bgImg.height;
    // the ratio of size between the two images (opposite to drawBoxesFromJson)
    var wRatio = trueW / workW;
    var hRatio = trueH / workH;

    // fill in the new shapes in the json data
    for (i=0; i<shapes.length; i++) {

      var shape = shapes[i];
      var topx = Math.round(shape.x * wRatio);
      var topy = Math.round(shape.y * hRatio);
      var bottomx = Math.round((shape.x + shape.w) * wRatio);
      var bottomy = Math.round((shape.y + shape.h) * hRatio);

      image.boxes[i] = {};
      image.boxes[i].topleft = {}
      image.boxes[i].topleft.x = topx;
      image.boxes[i].topleft.y = topy;
      image.boxes[i].label = shape.label;
      image.boxes[i].confidence = 1;
      image.boxes[i].bottomright = {}
      image.boxes[i].bottomright.x = bottomx;
      image.boxes[i].bottomright.y = bottomy;
    }
    document.getElementById('jsonContents').textContent = JSON.stringify(data);
  }
}

function buttonUpdateSelectedBoxLabel() {

  myCanvState.updateSelectedBoxLabel(document.getElementById("selectedBoxLabel").value);
}

function keyboardUpdateSelectedBoxLabel(e) {

  if (event.keyCode === 13)
    myCanvState.updateSelectedBoxLabel(document.getElementById("selectedBoxLabel").value);
}

function buttonDeleteSelectedBox() {

  myCanvState.deleteSelectedBox();
}

function keyboardDeleteSelectedBox() {

  if (event.keyCode === 46)
    myCanvState.deleteSelectedBox();
}

function buttonNewBox() {
  myCanvState.addShape(new Shape(50, 50, 50, 50, 'rgba(0,255,0,.6)', 'New'));
}

function displayInfoPopup() {
  var popup = document.getElementById("infoPopup");
  popup.classList.toggle("show");
}
</script>

<html>
<head>
  <link rel="stylesheet" href="styles.css">
</head>
<body onLoad='init()'>
  <img id="imageContents" src="samples/counter_work.jpg" style="display:none">
  <h1>Yolo Editor</h1>
  <table>
  <tr>
    <td valign="top">
      <div class="imageScroller">
        <img src="samples/counter_work.jpg" class="thumb" id="thumbImg0" onclick="selectThumbnailImage(0)">
        <br/>
        <img src="samples/thief2_work.jpg" class="thumb" id="thumbImg1" onclick="selectThumbnailImage(1)">
        <br/>
        <img src="samples/sample_office_work.jpg" class="thumb" id="thumbImg2" onclick="selectThumbnailImage(2)">
        <br/>
        <img src="samples/sample_dog_work.jpg" class="thumb" id="thumbImg3" onclick="selectThumbnailImage(3)">
        <br/>
        <img src="samples/sample_horses.jpg" class="thumb" id="thumbImg4" onclick="selectThumbnailImage(4)">
        <br/>
        <img src="samples/sample_person_work.jpg" class="thumb" id="thumbImg5" onclick="selectThumbnailImage(5)">
      </div>
    </td>
    <td valign="top">
      <canvas id="theCanvas" width="800" height="600" style="border:3px solid #000000;" tabindex='1' onkeyup="keyboardDeleteSelectedBox()"></canvas>
      <br/>
      <div class="popup" onclick="displayInfoPopup()">
        <img src="resources/info_icon.png" width="20" height="20"/>
        <span class="popuptext" id="infoPopup">
          Select images from the scroller.<br/>
          Click a box to select it, then drag, resize<br/>
          relabel, or delete it.<br/>
          <br/>
          Shortcuts:<br/>
          Double-click in image to create new box.<br/>
          Delete key: deletes a selected box.<br/>
          Enter key: saves a modified label.
        </span>
      </div>
        <br/>
        Select Image <input type="file" id="imageInput" alt="Select Image" onchange="handleImageFile()"/>
        Select JSON  <input type="file" id="jsonInput" alt="Select JSON" onchange="handleJsonFile()"/>
        <br/>
        <br/>
        <textarea id="jsonContents" readonly rows="5" cols="75">{"image": {
"width": 1920,
"height": 1080,
"status": "New",
"boxes":[{"confidence": 0.4, "label": "person", "bottomright": {"x": 981, "y": 1079}, "topleft": {"x": 40, "y": 0}}]
}}</textarea>
        <br/>
    </td>
    <td align="left">
      <input type="button" style="width:117px" id="newBoxButton" name="newBoxButton" value="New Box" onclick="buttonNewBox()"/>
      <br/>Selected Box:
      <input type="text" style="width:140px;margin-bottom:5px;margin-top:5px;" id="selectedBoxLabel" name="selectedBoxLabel" label="Box Label" onkeyup="keyboardUpdateSelectedBoxLabel(this)" placeholder="Press Enter to Save"/>
      <br/>
      <input type="button" style="width:117px" id="updateBoxButton" name="updateBoxButton" value="Save Label" onclick="buttonUpdateSelectedBoxLabel()"/>
      <input type="button" style="width:117px" id="deleteBoxButton" name="deleteBoxButton" value="Delete Box" onclick="buttonDeleteSelectedBox()"/>
      <br/>
    </td>
  </tr>
  </table>
</body>
</html>
